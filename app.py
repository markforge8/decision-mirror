import streamlit as st
import pandas as pd
from pathlib import Path
from datetime import datetime

with st.expander("ğŸ“Œ æŠ•èµ„å‰å¿…è¯»ï¼šåå¤§å¸¸è§é”™è¯¯ï¼ˆçœ‹åˆ°è¯·å†·é™ï¼‰", expanded=True):
    st.markdown("""
### âŒ 1. æƒ…ç»ªé©±åŠ¨å†³ç­–ï¼ˆè¿½æ¶¨æ€è·Œï¼‰
**ä¾‹å­ï¼š** æ¶¨äº†å†²è¿›å»ï¼Œè·Œäº†æ€¥ç€å–ã€‚  
**é”™è¯¯æ ‡è¯†ï¼šğŸš¨ æƒ…ç»ªå»ºä»“ = é•¿æœŸå¿…äº**

### âŒ 2. ä¸è®°å½•å½“æ—¶çš„æƒ³æ³•
**ä¾‹å­ï¼š** æ€»æ˜¯åµâ€œä½ è¯´æ¶¨/ä½ è¯´è·Œâ€ï¼Œä½†æ²¡äººè®°å¾—å½“æ—¶æƒ³ä»€ä¹ˆã€‚  
**é”™è¯¯æ ‡è¯†ï¼šâš ï¸ æ²¡è®°å½• = æ²¡é€»è¾‘**

### âŒ 3. æŠŠä¸€æ¬¡ç›ˆåˆ©å½“èƒ½åŠ›
**ä¾‹å­ï¼š** æ¶¨ä¸€æ¬¡å°±ä»¥ä¸ºè‡ªå·±æ˜¯é«˜æ‰‹ï¼Œä¸‹æ¬¡ç…§åšå°±çˆ†äºã€‚  
**é”™è¯¯æ ‡è¯†ï¼šâš ï¸ ä¸€æ¬¡æ¶¨ = å‡è±¡**

### âŒ 4. ä¸è®¾æ­¢æŸ
**ä¾‹å­ï¼š** ä¸€ç›´è¯´â€œå†ç­‰ç­‰â€ â†’ è¶Šç­‰è¶Šäºã€‚  
**é”™è¯¯æ ‡è¯†ï¼šğŸš¨ æ²¡æ­¢æŸ = æ·±æ¸Šæ¨¡å¼**

### âŒ 5. ç”¨å¿ƒæƒ…ç‚’è‚¡
**ä¾‹å­ï¼š** å¿ƒæƒ…å¥½å°±ä¹°ï¼Œå¿ƒæƒ…å·®å°±å–ã€‚  
**é”™è¯¯æ ‡è¯†ï¼šâŒ ç”¨å¿ƒæƒ…ç‚’è‚¡ = ç”¨è„šç‚’è‚¡**

### âŒ 6. ä¸çœ‹è¡Œä¸š/å®è§‚
**ä¾‹å­ï¼š** è¡Œä¸šé€€æ½®ä»ä¸æ–­åŠ ä»“ã€‚  
**é”™è¯¯æ ‡è¯†ï¼šâš ï¸ å¿˜è®°è¡Œä¸š = ç›²äººæ‘¸è±¡**

### âŒ 7. å¬æ¶ˆæ¯ä¹°è‚¡
**ä¾‹å­ï¼š** ç¾¤é‡Œè¯´â€œé‡å¤§åˆ©å¥½â€å°±å†²è¿›å»ã€‚  
**é”™è¯¯æ ‡è¯†ï¼šğŸš¨ å¬æ¶ˆæ¯ = å–æ¯’é¸¡æ±¤**

### âŒ 8. ä¸å¤ç›˜ï¼Œåªåµæ¶
**ä¾‹å­ï¼š** ä¸€æ¶¨ä¸€è·Œå°±äº’ç›¸æŒ‡è´£ã€‚  
**é”™è¯¯æ ‡è¯†ï¼šâŒ åµæ¶ â‰  å¤ç›˜**

### âŒ 9. ç”¨çŸ­çº¿æ³¢åŠ¨é¢„æµ‹è¶‹åŠ¿
**ä¾‹å­ï¼š** è·Œä¸¤å¤©å°±è¯´â€œå®Œäº†å®Œäº†â€ã€‚  
**é”™è¯¯æ ‡è¯†ï¼šâš ï¸ ä¸‰å¤©åˆ¤æ–­ä¸‰å¹´ = éŸ­èœé€»è¾‘**

### âŒ 10. å›é¿äºæŸï¼Œä¸æ•¢å†™ç»“æœ
**ä¾‹å­ï¼š** ä¸æ•¢å¡«â€œæœ€ç»ˆæ¶¨è·Œå¹…â€ã€‚  
**é”™è¯¯æ ‡è¯†ï¼šğŸš¨ å›é¿çœŸç›¸ = æ°¸ä¹…äºæŸ
    """)

with st.expander("ğŸ“Œ æŠ•èµ„å‰å¿…è¯»ï¼šå“¥çš„åæ¡ç³»ç»Ÿæé†’ï¼ˆå¼ºåˆ¶å†·é™ç‰ˆï¼‰", expanded=True):
    st.markdown("""
**1. å¸‚åœºä¸æ˜¯æƒ…ç»ªæ¸¸æˆï¼Œæ˜¯æ¦‚ç‡æ¸¸æˆã€‚**  
ä»»ä½•ç”±â€œå…´å¥‹/å®³æ€•/ä¸ç”˜â€åšå‡ºçš„å†³ç­–ï¼Œé•¿æœŸèƒœç‡å¿…ç„¶ä½äºéšæœºã€‚

**2. ä¸è®°å½• = ä¸è¿›åŒ–ã€‚**  
ä½ ä¸å†™ä¸‹å½“æ—¶çš„æƒ³æ³•ï¼Œå°±æ°¸è¿œä¸çŸ¥é“è‡ªå·±å¦‚ä½•äºçš„ã€‚

**3. ç›ˆåˆ©ä¸æ˜¯èƒ½åŠ›ï¼Œå¤ç›˜æ‰æ˜¯èƒ½åŠ›ã€‚**

**4. æ²¡é€€å‡ºæ¡ä»¶ = æ²¡åšå†³ç­–ã€‚**

**5. æ¶¨è·Œæ˜¯åé¦ˆï¼Œä¸æ˜¯æŒ‡å¼•ã€‚**

**6. ä¿¡æ¯è¶Šå¤šï¼Œåˆ¤æ–­è¶Šä¹±ã€‚æ€è€ƒæ¯”æ¶ˆæ¯é‡è¦ã€‚**

**7. æ¯ç¬”äº¤æ˜“é—®è‡ªå·±ä¸€å¥ï¼šæˆ‘çš„é€»è¾‘æ˜¯ä»€ä¹ˆï¼Ÿ**

**8. å¸‚åœºæ˜¯å¯¹çš„ï¼Œé”™çš„æ˜¯æƒ…ç»ªã€‚**

**9. ä½ çš„å¯¹æ‰‹æ˜¯ä¸Šä¸€æ¬¡çš„è‡ªå·±ï¼Œä¸æ˜¯å¸‚åœºã€‚**

**10. èµšé’±ä¸æ˜¯é¢„æµ‹æ¶¨è·Œï¼Œè€Œæ˜¯ç¨³å®šæ‰§è¡Œç³»ç»Ÿã€‚**
    """)

# =====================
# åŸºç¡€è®¾ç½®
# =====================
st.set_page_config(page_title="å†³ç­–é•œ Â· è‚¡ç¥¨å†³ç­–è®°å½•å·¥å…·", layout="centered")

DATA_DIR = Path("data")
DATA_FILE = DATA_DIR / "stock_records.csv"

COLUMNS = [
    "æ—¶é—´",
    "æ“ä½œè€…",
    "è‚¡ç¥¨ä»£ç ",
    "è‚¡ç¥¨åç§°",
    "æ“ä½œç±»å‹",
    "ä¹°å–ç†ç”±",
    "é€»è¾‘åˆ†ç±»",
    "é¢„æœŸæ¶¨å¹…(%)",
    "é¢„æœŸæ—¶é—´èŒƒå›´",
    "æ­¢æŸç‚¹(%)",
    "å½“æ—¶æƒ…ç»ª",
    "æœ€ç»ˆæ¶¨è·Œå¹…(%)",  # æ–°å¢
]


# =====================
# å·¥å…·å‡½æ•°
# =====================
def ensure_data_file():
    DATA_DIR.mkdir(parents=True, exist_ok=True)
    if not DATA_FILE.exists():
        df = pd.DataFrame(columns=COLUMNS)
        df.to_csv(DATA_FILE, index=False, encoding="utf-8-sig")


def load_data() -> pd.DataFrame:
    """åŠ è½½ CSVï¼Œå¹¶è‡ªåŠ¨è¡¥å…¨ç¼ºå¤±åˆ—ï¼Œé¿å… KeyErrorã€‚"""
    ensure_data_file()
    df = pd.read_csv(DATA_FILE, encoding="utf-8-sig")

    # è‡ªåŠ¨è¡¥é½ç¼ºå¤±çš„åˆ—
    for col in COLUMNS:
        if col not in df.columns:
            df[col] = ""

    # åªä¿ç•™éœ€è¦çš„åˆ—ï¼ˆå…¶ä»–æ—§åˆ—ä¹Ÿè‡ªåŠ¨è¿‡æ»¤æ‰ï¼‰
    df = df[COLUMNS]

    return df


def append_record(record: dict):
    ensure_data_file()
    df_new = pd.DataFrame([record])
    if DATA_FILE.exists() and DATA_FILE.stat().st_size > 0:
        df_new.to_csv(DATA_FILE, mode="a", header=False, index=False, encoding="utf-8-sig")
    else:
        df_new.to_csv(DATA_FILE, index=False, encoding="utf-8-sig")


# =====================
# é¡µé¢åˆ‡æ¢
# =====================
st.sidebar.title("å†³ç­–é•œ Decision Mirror")
page = st.sidebar.radio("é€‰æ‹©é¡µé¢", ["è®°å½•ä¸€ç¬”å†³ç­–", "æŸ¥çœ‹ä¸å¤ç›˜ï¼ˆå«èƒœç‡ç»Ÿè®¡ï¼‰"])

st.sidebar.markdown("---")
st.sidebar.caption("æç¤ºï¼šæ¯æ¬¡ä¹°/å–å‰å†™ä¸€ä¸‹å½“æ—¶æ€ä¹ˆæƒ³ï¼Œå¯å‡å°‘äº‰åµã€‚")

# =====================
# é¡µé¢ä¸€ï¼šè®°å½•å†³ç­–
# =====================
if page == "è®°å½•ä¸€ç¬”å†³ç­–":

    st.title("è®°å½•ä¸€ç¬”æ–°çš„è‚¡ç¥¨å†³ç­–")

    col1, col2 = st.columns(2)
    with col1:
        operator = st.text_input("æ“ä½œè€…ï¼ˆçˆ¸çˆ¸ / å¦ˆå¦ˆï¼‰")
    with col2:
        stock_code = st.text_input("è‚¡ç¥¨ä»£ç ")

    stock_name = st.text_input("è‚¡ç¥¨åç§°ï¼ˆå¯å†™å¯ä¸å†™ï¼‰")

    action = st.radio("æ“ä½œç±»å‹", ["å‡†å¤‡ä¹°å…¥", "å‡†å¤‡å–å‡º"])

    reason = st.text_area("ä¹°/å–ç†ç”±ï¼ˆå†™è¶Šå…·ä½“è¶Šå¥½ï¼‰")

    logic = st.selectbox(
        "æ­¤æ¬¡å†³ç­–çš„ä¸»è¦é€»è¾‘åˆ†ç±»",
        ["å®è§‚ï¼ˆæ”¿ç­–/åˆ©ç‡/ç»æµï¼‰", "è¡Œä¸šï¼ˆèµ›é“è¶‹åŠ¿ï¼‰", "ä¸ªè‚¡ï¼ˆå…¬å¸åŸºæœ¬é¢ï¼‰", "æƒ…ç»ªï¼ˆå†²åŠ¨/ææƒ§/ä¸ç”˜ï¼‰"],
    )

    col3, col4 = st.columns(2)
    with col3:
        expect_gain = st.text_input("é¢„æœŸæ¶¨å¹… %")
    with col4:
        time_range = st.text_input("é¢„æœŸæ—¶é—´èŒƒå›´ï¼ˆå¦‚3ä¸ªæœˆï¼‰")

    stop_loss = st.text_input("æ­¢æŸç‚¹ %ï¼ˆè·Œå¤šå°‘å–ï¼‰")

    emotion = st.selectbox(
        "æ­¤åˆ»çš„æƒ…ç»ª",
        ["å†·é™", "å…´å¥‹", "ææƒ§", "ä¸ç”˜", "æŠ¥å¤"],
    )

    # ---- æ–°å¢â€œç»“æœæ¶¨è·Œå¹…â€ ----
    result_gain = st.text_input("æœ€ç»ˆæ¶¨è·Œå¹… %ï¼ˆä¹‹åå¡«ï¼Œæˆ–å…ˆç•™ç©ºï¼‰", placeholder="ä¾‹å¦‚ï¼š+8 æˆ– -12")

    st.markdown("---")

    if st.button("ğŸ’¾ ä¿å­˜æœ¬æ¬¡å†³ç­–", use_container_width=True):
        if not operator.strip():
            st.error("è¯·å¡«å†™æ“ä½œè€…ã€‚")
        elif not stock_code.strip():
            st.error("è¯·å¡«å†™è‚¡ç¥¨ä»£ç ã€‚")
        elif not reason.strip():
            st.error("è¯·å¡«å†™ä¹°å–ç†ç”±ã€‚")
        else:
            record = {
                "æ—¶é—´": datetime.now().strftime("%Y-%m-%d %H:%M"),
                "æ“ä½œè€…": operator.strip(),
                "è‚¡ç¥¨ä»£ç ": stock_code.strip(),
                "è‚¡ç¥¨åç§°": stock_name.strip(),
                "æ“ä½œç±»å‹": action,
                "ä¹°å–ç†ç”±": reason.strip(),
                "é€»è¾‘åˆ†ç±»": logic,
                "é¢„æœŸæ¶¨å¹…(%)": expect_gain.strip(),
                "é¢„æœŸæ—¶é—´èŒƒå›´": time_range.strip(),
                "æ­¢æŸç‚¹(%)": stop_loss.strip(),
                "å½“æ—¶æƒ…ç»ª": emotion,
                "æœ€ç»ˆæ¶¨è·Œå¹…(%)": result_gain.strip(),
            }
            append_record(record)
            st.success("å·²ä¿å­˜ï¼ç­‰å¾…æœªæ¥å¸‚åœºæ¥å½“â€˜é•œå­â€™ã€‚")
            st.balloons()


# =====================
# é¡µé¢äºŒï¼šå¤ç›˜é¡µé¢
# =====================
elif page == "æŸ¥çœ‹ä¸å¤ç›˜ï¼ˆå«èƒœç‡ç»Ÿè®¡ï¼‰":

    st.title("å¤ç›˜ä¸­å¿ƒ Â· æ•°æ®æ¯”äº‰åµæ›´æœ‰è¯´æœåŠ›")

    df = load_data()

    if df.empty:
        st.info("è¿˜æ²¡æœ‰è®°å½•ï¼Œå»â€œè®°å½•å†³ç­–â€é¡µé¢å†™ä¸€æ¡å§ã€‚")
    else:
        df_display = df.sort_values("æ—¶é—´", ascending=False)
        st.dataframe(df_display, use_container_width=True, height=400)

        st.markdown("---")
        st.subheader("ğŸ“Š é€»è¾‘ç±»å‹å‡ºç°æ¬¡æ•°")
        st.bar_chart(df["é€»è¾‘åˆ†ç±»"].value_counts())

        st.subheader("ğŸ“Š æƒ…ç»ªå‡ºç°é¢‘ç‡")
        st.bar_chart(df["å½“æ—¶æƒ…ç»ª"].value_counts())


        # è½¬æ¢æ¶¨è·Œä¸ºæ•°å­—
        def to_float(x):
            try:
                return float(str(x).replace("%", ""))
            except:
                return None


        emotion_avg = None

        df["æœ€ç»ˆæ¶¨è·Œå¹…_float"] = df["æœ€ç»ˆæ¶¨è·Œå¹…(%)"].apply(to_float)

        st.markdown("---")
        st.subheader("ğŸ† å„æ“ä½œè€…èƒœç‡ï¼ˆç»“æœ > 0 å³ä¸ºèƒœï¼‰")

        df_valid = df.dropna(subset=["æœ€ç»ˆæ¶¨è·Œå¹…_float"])
        if df_valid.empty:
            st.info("è¿˜æ²¡æœ‰ä»»ä½•å¡«å†™äº†å®é™…æ¶¨è·Œç»“æœçš„æ•°æ®ã€‚")
        else:
            win_rate = (
                df_valid.groupby("æ“ä½œè€…")["æœ€ç»ˆæ¶¨è·Œå¹…_float"]
                .apply(lambda x: (x > 0).sum() / len(x) * 100)
                .round(2)
            )
            st.write(win_rate)

        st.markdown("---")
        st.subheader("ğŸ’¥ æƒ…ç»ªç±»å‹çš„å¹³å‡æ¶¨è·Œå¹…ï¼ˆæœ€èƒ½çœ‹å‡ºè°å®¹æ˜“äºé’±ï¼‰")

        # ---- å¤„ç†â€œæœ€ç»ˆæ¶¨è·Œå¹…_floatâ€ä¸ºçœŸæ­£çš„æ•°å­— ----
        df_valid = df.dropna(subset=["æœ€ç»ˆæ¶¨è·Œå¹…_float"]).copy()

        # å¼ºåˆ¶æŠŠæ‰€æœ‰å€¼è½¬ä¸º floatï¼Œæ— æ³•è½¬çš„å˜ä¸º NaN
        df_valid["æœ€ç»ˆæ¶¨è·Œå¹…_float"] = pd.to_numeric(df_valid["æœ€ç»ˆæ¶¨è·Œå¹…_float"], errors="coerce")

        # å†æ¬¡è¿‡æ»¤ NaNï¼Œç¡®ä¿å¹³å‡å€¼è®¡ç®—æ—¶ä¸€å®šæ˜¯æ•°å­—
        df_valid = df_valid.dropna(subset=["æœ€ç»ˆæ¶¨è·Œå¹…_float"])

        if df_valid.empty:
            st.info("ç›®å‰è¿˜æ²¡æœ‰å¯ç”¨äºæƒ…ç»ªå¹³å‡æ¶¨è·Œçš„è®°å½•ï¼ˆè¯·è‡³å°‘å¡«å†™ä¸€æ¬¡å®é™…ç»“æœï¼‰")
        else:
            emotion_avg = (
                df_valid.groupby("å½“æ—¶æƒ…ç»ª")["æœ€ç»ˆæ¶¨è·Œå¹…_float"]
                .mean()
                .round(2)
                .sort_values()
            )
            st.write(emotion_avg)

        st.write(emotion_avg)

        st.markdown("---")
        st.subheader("ğŸ“„ ä¸€é”®å¯¼å‡ºå¤ç›˜æŠ¥å‘Š")

        if st.button("å¯¼å‡º CSV æŠ¥å‘Š", use_container_width=True):
            df.to_csv("å¤ç›˜æŠ¥å‘Š.csv", index=False, encoding="utf-8-sig")
            st.success("æŠ¥å‘Šå·²ç”Ÿæˆï¼šå¤ç›˜æŠ¥å‘Š.csvï¼ˆåœ¨é¡¹ç›®ç›®å½•é‡Œï¼‰")

